#include <unistd.h>
#include <stdio.h>
#include <string.h>

/*
seteuid()  sets the effective user ID of the calling process.  Unprivi‚Äê
       leged processes may only set the effective user ID to the real user ID,
       the effective user ID or the saved set-user-ID.
*/

/*
setuid()  sets  the  effective  user ID of the calling process.  If the
       calling process is privileged (more precisely: if the process  has  the
       CAP_SETUID  capability  in  its user namespace), the real UID and saved
       set-user-ID are also set.
*/

/*
       getuid() returns the real user ID of the calling process.

       geteuid() returns the effective user ID of the calling process.
*/

void cannotSetBack(){

    printf("Effective UID: %d, Real UID: %d\n", geteuid(), getuid());
    puts("Dropping my privileges ...\n");
    setuid(1000);
    printf("Effective UID: %d, Real UID: %d\n", geteuid(), getuid());
    puts("Trying to regain privileges ... \n");

    if(seteuid(0) == -1)
        puts("Cannot set back Effective UID to 0 because also the saved UID was set\n");

}

void canSetBack(){

    printf("Effective UID: %d, Real UID: %d\n", geteuid(), getuid());
    puts("Modifying only Effective UID ...\n");
    seteuid(1000);
    printf("Effective UID: %d, Real UID: %d\n", geteuid(), getuid());
    puts("Trying to regain privileges ... \n");

    if(seteuid(0) == 0)
        printf("Effective UID restored to: %d\n", geteuid());

}

int main(int argc, char *argv[]){

    if(argc < 2){
        puts("Usage: ./suid 1|2");
        return -1;
    }
    if(!strcmp("1", argv[1]))
        cannotSetBack();
    else 
        canSetBack();
    return 0; 
}