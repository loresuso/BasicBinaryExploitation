#!/bin/bash

kflags="nokaslr nosmap"
case "$1" in
	1)
		kflags+=" nosmep"
		;;
	2|3)
		;;
	*)
		echo "usage: $0 1|2|3"
		exit 1
		;;
esac

set -e
make -C exploit-$1
rm -f rootfs-$1.cpio
rm -rf .rootfs
mkdir .rootfs
(
	cd .rootfs
	sudo cpio -i < ../rootfs.cpio
	sudo cp ../exploit-$1/exploit exploit-$1
	sudo find . | cpio -H newc -o > ../rootfs-$1.cpio
)

qemu-system-x86_64 \
    -m 64M \
    -nographic \
    -kernel bzImage-$1 \
    -append "console=ttyS0 loglevel=3 exercise-$1 $kflags" \
    -monitor /dev/null \
    -initrd rootfs-$1.cpio \
    -cpu Skylake-Server
